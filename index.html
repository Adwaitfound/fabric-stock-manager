<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric Stock Manager</title>
    <!-- Load Tailwind CSS from the direct source -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }

        .card {
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .loading-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Mobile Specific Styles */
        @media (max-width: 768px) {
            .form-input-group {
                width: 100%;
                max-width: 350px;
                /* Constrain main form elements */
                margin-left: auto;
                margin-right: auto;
            }
        }
    </style>
</head>

<body>
    <div id="root">
        <div class="loading-container">
            <div class="spinner mr-3"></div>
            <div class="text-xl font-medium text-blue-500">Loading Application...</div>
        </div>
    </div>

    <!-- React and Babel for JSX in browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs (ALL IMPORTS are now added to the window object for Babel access) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import * as auth from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import * as firestore from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase modules globally for the Babel script to use
        window.firebase = {
            initializeApp,
            auth: auth,
            firestore: firestore,
        };

        // This is a safety check: expose all needed functions globally
        Object.assign(window.firebase, auth);
        Object.assign(window.firebase, firestore);

        // This is the cleanest way to signal that the module imports are complete
        window.FIREBASE_MODULES_LOADED = true;
    </script>


    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Icons (simplified from lucide-react for single-file HTML)
        const Plus = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const Trash2 = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>;
        const Gauge = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 14v4"></path><path d="M8.5 13.5l1 1"></path><path d="M15.5 13.5l-1 1"></path><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"></path></svg>;
        const Ruler = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 12L12 16L8 12"></path><path d="M4 4h16v16H4z"></path></svg>;
        const Shirt = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.5 4.5l-2.5 7h-11l-2.5-7"></path><path d="M22 10l-2 10"></path><path d="M2 10l2 10"></path><path d="M12 2l4 2.5v2.5H8V4.5z"></path></svg>;
        const Camera = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-3h4l2 3h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2z"></path><circle cx="12" cy="13" r="3"></circle></svg>;
        const Image = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>;

        // -----------------------------------------------------
        // --- START: FIREBASE CONFIGURATION (ALREADY INSERTED) ---
        // -----------------------------------------------------

        // CONFIGURATION IS INSERTED AND SHOULD NOT NEED TO CHANGE
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAvaMaBZKES07mXlxQzdAqRqLT0x4HOGKc",
            authDomain: "poshapp-46816131-1bf59.firebaseapp.com",
            projectId: "poshapp-46816131-1bf59",
            storageBucket: "poshapp-46816131-1bf59.firebasestorage.app",
            messagingSenderId: "531880756309",
            appId: "1:531880756309:web:b4598124d889fa347a00dc"
        };

        // This is a default App ID used for the public data path.
        const APP_ID = 'poshakh-fabric-manager';

        // Set maximum file size (750KB) for Base64 storage due to 1MB Firestore limit
        const MAX_FILE_SIZE_BYTES = 750 * 1024;

        // -----------------------------------------------------
        // --- END: FIREBASE CONFIGURATION ---
        // -----------------------------------------------------


        // Helper function to generate a unique ID
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

        // ORIGINAL HELPER: Converts file to Base64 without compression
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();

            reader.onerror = (error) => {
                console.error("FileReader Error:", error);
                reject(new Error("Failed to read file."));
            };

            reader.readAsDataURL(file);

            reader.onload = (event) => {
                resolve(event.target.result);
            };
        });

        // Helper function to calculate byte size from Base64 Data URL for checking the limit
        const getBase64ByteSize = (dataUrl) => {
            const base64String = dataUrl.split(',')[1];
            return Math.ceil(base64String.length * 3 / 4);
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [userEmail, setUserEmail] = useState(null); // Will be static "Anonymous User"
            const [fabrics, setFabrics] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isUploading, setIsUploading] = useState(false);

            // Refs for the hidden file inputs
            const cameraInputRef = useRef(null);
            const galleryInputRef = useRef(null);

            // Form State
            const [newFabric, setNewFabric] = useState({
                name: '',
                totalLength: '',
                unit: 'meters',
                lengthRequiredPerOutfit: '',
            });
            const [newFabricImageFile, setNewFabricImageFile] = useState(null);

            // State for updating current stock
            const [updateFabricId, setUpdateFabricId] = useState(null);
            const [updateAmountUsed, setUpdateAmountUsed] = useState('');

            // ------------------------------------
            // 1. FIREBASE INITIALIZATION & ANONYMOUS AUTHENTICATION
            // ------------------------------------

            useEffect(() => {
                if (!window.FIREBASE_MODULES_LOADED) {
                    console.error("Firebase module imports are not yet available.");
                    setLoading(true);
                    return;
                }

                const initializeFirebase = async () => {
                    const { initializeApp, getFirestore, getAuth, onAuthStateChanged, signInAnonymously } = window.firebase;

                    try {
                        const app = initializeApp(FIREBASE_CONFIG);
                        const firestore = getFirestore(app);
                        const firebaseAuth = getAuth(app);

                        setDb(firestore);
                        setAuth(firebaseAuth);

                        // --- ANONYMOUS SIGN-IN ---
                        await signInAnonymously(firebaseAuth);

                        onAuthStateChanged(firebaseAuth, (user) => {
                            if (user) {
                                setUserId(user.uid);
                                // Static email/identifier for Anonymous mode
                                setUserEmail("Anonymous User");
                                setError(null);
                            } else {
                                setUserId(null);
                                setUserEmail(null);
                            }
                            setLoading(false);
                        });
                    } catch (e) {
                        console.error("Error during Firebase setup:", e);
                        setError("Failed to connect to Firebase. Ensure **Anonymous Sign-in** is enabled in your Firebase Console and check your network connection.");
                        setLoading(false);
                    }
                };

                initializeFirebase();
            }, []);

            // Handler for file selection from either input
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setNewFabricImageFile(file);
                }
                // Clear the input value so the same file can be selected again if cancelled
                e.target.value = null;
            };

            // ------------------------------------
            // 2. FIRESTORE REAL-TIME LISTENER (CRUD R)
            // ------------------------------------

            useEffect(() => {
                if (!db || !userId) return;

                const { collection, query, onSnapshot } = window.firebase.firestore;

                // PUBLIC PATH: /artifacts/{APP_ID}/public/data/poshakh_fabric_measure
                const fabricsCollectionPath = `artifacts/${APP_ID}/public/data/poshakh_fabric_measure`;
                const q = query(collection(db, fabricsCollectionPath));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fabricList = snapshot.docs.map(doc => {
                        const data = doc.data();
                        const currentLength = parseFloat(data.currentLength) || 0;
                        const lengthRequiredPerOutfit = parseFloat(data.lengthRequiredPerOutfit) || 1;

                        const potentialOutfits = Math.floor(currentLength / lengthRequiredPerOutfit);

                        return {
                            id: doc.id,
                            ...data,
                            currentLength,
                            lengthRequiredPerOutfit,
                            potentialOutfits,
                        };
                    });
                    setFabrics(fabricList);
                }, (e) => {
                    console.error("Firestore Error:", e);
                    setError("Failed to fetch fabrics inventory in real-time. Check Firestore security rules to ensure authenticated users have read access.");
                });

                return () => unsubscribe();
            }, [db, userId]);

            // ------------------------------------
            // 3. FIRESTORE MUTATION FUNCTIONS (CRUD CUD)
            // ------------------------------------

            const handleAddFabric = async (e) => {
                e.preventDefault();
                if (!db || !userId) {
                    setError("Connection error: Please wait for the application to finish loading.");
                    return;
                }

                const { doc, setDoc, serverTimestamp } = window.firebase.firestore;
                const { name, totalLength, unit, lengthRequiredPerOutfit } = newFabric;
                let imageUrlToStore = '';

                if (!name || !totalLength || !lengthRequiredPerOutfit) {
                    setError("Please fill in the fabric Name, Total Length, and Required Length per Outfit.");
                    return;
                }

                setIsUploading(true);
                setError(null);

                if (newFabricImageFile) {
                    try {
                        const rawDataUrl = await fileToBase64(newFabricImageFile);
                        const sizeInBytes = getBase64ByteSize(rawDataUrl);

                        if (sizeInBytes > MAX_FILE_SIZE_BYTES) {
                            setError(`Image is too large (${(sizeInBytes / 1024).toFixed(0)}KB). The limit is 750 KB.`);
                            setIsUploading(false);
                            return;
                        }

                        imageUrlToStore = rawDataUrl;
                    } catch (error) {
                        console.error("Error processing image:", error);
                        setError("Failed to process image file. The file may be corrupt or too large.");
                        setIsUploading(false);
                        return;
                    }
                } else {
                    imageUrlToStore = `https://placehold.co/100x100/38bdf8/ffffff?text=${name.substring(0, 2).toUpperCase()}`;
                }


                const docId = generateId();
                const newDoc = {
                    name,
                    totalLength: parseFloat(totalLength),
                    currentLength: parseFloat(totalLength),
                    unit,
                    lengthRequiredPerOutfit: parseFloat(lengthRequiredPerOutfit),
                    imageUrl: imageUrlToStore,
                    createdAt: serverTimestamp(),
                    updatedByEmail: userEmail,
                    updatedAt: serverTimestamp(),
                };

                try {
                    const docRef = doc(db, `artifacts/${APP_ID}/public/data/poshakh_fabric_measure`, docId);
                    await setDoc(docRef, newDoc);
                    setNewFabric({ name: '', totalLength: '', unit: 'meters', lengthRequiredPerOutfit: '' });
                    setNewFabricImageFile(null);
                } catch (e) {
                    console.error("Error adding document: ", e);
                    setError("Failed to add new fabric stock to Firebase. Ensure all data fields are correct and check security rules.");
                } finally {
                    setIsUploading(false);
                }
            };

            const handleDeleteFabric = async (id) => {
                if (!db || !userId) return;
                const { doc, deleteDoc } = window.firebase.firestore;

                try {
                    const docRef = doc(db, `artifacts/${APP_ID}/public/data/poshakh_fabric_measure`, id);
                    await deleteDoc(docRef);
                    setError(null);
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    setError("Failed to delete fabric entry from Firebase.");
                }
            };

            const handleUpdateStock = async (e) => {
                e.preventDefault();
                if (!db || !userId || !updateFabricId || !updateAmountUsed) return;
                const { doc, setDoc, serverTimestamp } = window.firebase.firestore;

                const fabric = fabrics.find(f => f.id === updateFabricId);
                if (!fabric) return;

                const amountUsed = parseFloat(updateAmountUsed);
                if (isNaN(amountUsed) || amountUsed <= 0) {
                    setError("Please enter a valid amount of fabric used (a positive number).");
                    return;
                }

                const newCurrentLength = fabric.currentLength - amountUsed;

                if (newCurrentLength < 0) {
                    setError(`Cannot use ${amountUsed} ${fabric.unit}. Only ${fabric.currentLength.toFixed(2)} ${fabric.unit} remaining.`);
                    return;
                }

                try {
                    const docRef = doc(db, `artifacts/${APP_ID}/public/data/poshakh_fabric_measure`, updateFabricId);
                    await setDoc(docRef, {
                        currentLength: newCurrentLength,
                        updatedByEmail: userEmail,
                        updatedAt: serverTimestamp(),
                    }, { merge: true });

                    setUpdateFabricId(null);
                    setUpdateAmountUsed('');
                    setError(null);
                } catch (e) {
                    console.error("Error updating stock: ", e);
                    setError("Failed to update fabric stock in Firebase.");
                }
            };

            // ------------------------------------
            // 4. DERIVED STATE & UI RENDERING
            // ------------------------------------

            const totalPotentialOutfits = useMemo(() => {
                return fabrics.reduce((sum, f) => sum + f.potentialOutfits, 0);
            }, [fabrics]);

            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-50">
                        <div className="spinner mr-3"></div>
                        <div className="text-xl font-medium text-blue-500">Connecting to Firebase...</div>
                    </div>
                );
            }

            // No Login Gate needed; connection is automatic

            if (error) {
                return (
                    <div className="p-8 bg-red-100 border-l-4 border-red-500 text-red-700 min-h-screen">
                        <p className="font-bold">Application Error</p>
                        <p>{error}</p>
                        <p className="mt-2 text-sm text-gray-600">User ID: {userId || 'N/A'}</p>
                    </div>
                );
            }

            return (
                <div className="p-4 md:p-8 bg-gray-50 min-h-screen font-sans">
                    <div className="max-w-6xl mx-auto">
                        <div className="flex justify-between items-center mb-2">
                            <h1 className="text-4xl font-extrabold text-gray-900">Fabric Stock Manager</h1>
                            {/* Removed Sign Out Button */}
                        </div>
                        <p className="text-sm text-gray-500 mb-6 flex justify-between items-center">
                            Storage Mode: **SHARED (Firebase)** | User ID:
                            <span className="font-mono bg-gray-200 p-1 rounded-md text-xs">{userId}</span>
                            {userEmail && (
                                <span className="ml-4">Updater:
                                    <span className="font-mono bg-gray-200 p-1 rounded-md text-xs ml-1">{userEmail}</span>
                                </span>
                            )}
                        </p>
                        <p className="text-sm text-green-700 mb-6 bg-green-100 p-2 rounded-lg border border-green-300 font-semibold">
                            <span className="font-bold">Team Sharing Active:</span> Data is now saved and synchronized in real-time on your Firebase project.
                        </p>

                        {/* Global Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div className="card bg-blue-500 text-white p-6 rounded-xl shadow-lg flex items-center">
                                <Gauge className="w-8 h-8 mr-4" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Fabrics</p>
                                    <p className="text-3xl font-bold">{fabrics.length}</p>
                                </div>
                            </div>
                            <div className="card bg-green-500 text-white p-6 rounded-xl shadow-lg flex items-center col-span-1 md:col-span-2">
                                <Shirt className="w-8 h-8 mr-4" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Potential Outfits Remaining</p>
                                    <p className="text-3xl font-bold">{totalPotentialOutfits}</p>
                                </div>
                            </div>
                        </div>

                        {/* Add New Fabric Section */}
                        <div className="card bg-white p-6 rounded-xl shadow-lg mb-8">
                            <h2 className="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                                <Plus className="w-5 h-5 mr-2" /> Add New Fabric Stock
                            </h2>
                            <form onSubmit={handleAddFabric} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {/* Fabric Name */}
                                <div className="form-input-group">
                                    <label className="block text-sm font-medium text-gray-700">Fabric Name</label>
                                    <input
                                        type="text"
                                        required
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500"
                                        value={newFabric.name}
                                        onChange={(e) => setNewFabric({ ...newFabric, name: e.target.value })}
                                    />
                                </div>

                                {/* Total Length */}
                                <div className="form-input-group">
                                    <label className="block text-sm font-medium text-gray-700">Total Length in Stock</label>
                                    <div className="mt-1 flex rounded-md shadow-sm">
                                        <input
                                            type="number"
                                            step="0.01"
                                            min="0"
                                            required
                                            className="flex-1 block w-full rounded-l-md border-gray-300 p-2 border focus:ring-blue-500 focus:border-blue-500"
                                            value={newFabric.totalLength}
                                            onChange={(e) => setNewFabric({ ...newFabric, totalLength: e.target.value })}
                                        />
                                        <select
                                            className="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm"
                                            value={newFabric.unit}
                                            onChange={(e) => setNewFabric({ ...newFabric, unit: e.target.value })}
                                        >
                                            <option value="meters">meters</option>
                                            <option value="yards">yards</option>
                                        </select>
                                    </div>
                                </div>

                                {/* Length Required Per Outfit */}
                                <div className="form-input-group">
                                    <label className="block text-sm font-medium text-gray-700">Length Required per Outfit</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        min="0.1"
                                        required
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500"
                                        value={newFabric.lengthRequiredPerOutfit}
                                        onChange={(e) => setNewFabric({ ...newFabric, lengthRequiredPerOutfit: e.target.value })}
                                    />
                                    <p className="mt-1 text-xs text-gray-500">How much {newFabric.unit} to make one average outfit?</p>
                                </div>

                                {/* Image Capture Input */}
                                <div className="md:col-span-2 lg:col-span-3 form-input-group">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Fabric Image (Choose Option)</label>
                                    <div className="flex space-x-3 mb-2">
                                        {/* Hidden Input for Camera */}
                                        <input
                                            ref={cameraInputRef}
                                            type="file"
                                            accept="image/*"
                                            capture="environment"
                                            style={{ display: 'none' }}
                                            onChange={handleFileChange}
                                        />
                                        {/* Hidden Input for Gallery */}
                                        <input
                                            ref={galleryInputRef}
                                            type="file"
                                            accept="image/*"
                                            style={{ display: 'none' }}
                                            onChange={handleFileChange}
                                        />

                                        <button
                                            type="button"
                                            onClick={() => cameraInputRef.current && cameraInputRef.current.click()}
                                            className="flex-1 inline-flex flex-col items-center justify-center p-3 border border-blue-600 rounded-md shadow-sm text-sm font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 transition duration-150"
                                        >
                                            <Camera className="w-8 h-8" />
                                            <span className="mt-1">Take Photo</span>
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => galleryInputRef.current && galleryInputRef.current.click()}
                                            className="flex-1 inline-flex flex-col items-center justify-center p-3 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150"
                                        >
                                            <Image className="w-8 h-8" />
                                            <span className="mt-1">Upload from Gallery</span>
                                        </button>
                                    </div>

                                    {newFabricImageFile && <p className="mt-1 text-xs text-green-600">File selected: {newFabricImageFile.name}</p>}
                                    <p className="mt-1 text-xs text-gray-500 font-semibold text-red-600">
                                        Image size must be less than 750 KB.
                                    </p>
                                </div>

                                {/* Submit Button */}
                                <div className="md:col-span-2 lg:col-span-3 pt-2 form-input-group">
                                    <button
                                        type="submit"
                                        disabled={isUploading}
                                        className={`w-full justify-center inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white transition duration-150 ${isUploading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500'}`}
                                    >
                                        {isUploading ? (
                                            <>
                                                <span className="spinner mr-2"></span> Uploading...
                                            </>
                                        ) : (
                                            <>
                                                <Plus className="w-5 h-5 mr-2" /> Add Fabric to Stock
                                            </>
                                        )}
                                    </button>
                                </div>
                            </form>
                        </div>

                        {/* Current Stock List */}
                        <h2 className="text-3xl font-bold text-gray-900 mb-6">Current Fabric Stock ({fabrics.length} items)</h2>

                        {fabrics.length === 0 ? (
                            <div className="p-8 text-center bg-white rounded-xl shadow-lg text-gray-500">No fabric stock recorded yet. Use the form above to add an item!</div>
                        ) : (
                            <div className="grid grid-cols-1 gap-6">
                                {fabrics.map((fabric) => (
                                    <div key={fabric.id} className="card bg-white p-5 rounded-xl shadow-md flex flex-col md:flex-row justify-between items-start md:items-center">
                                        <div className="flex items-center mb-4 md:mb-0 w-full md:w-3/5">
                                            {/* Image Placeholder/Display */}
                                            <img
                                                src={fabric.imageUrl}
                                                alt={fabric.name}
                                                className="w-20 h-20 object-cover rounded-lg shadow-inner mr-4 border border-gray-200"
                                                onError={(e) => {
                                                    e.target.onerror = null;
                                                    e.target.src = `https://placehold.co/80x80/ef4444/ffffff?text=Image+N/A`;
                                                }}
                                            />
                                            {/* Fabric Details */}
                                            <div>
                                                <h3 className="text-xl font-bold text-gray-900">{fabric.name}</h3>
                                                <div className="text-sm text-gray-600 space-y-1 mt-1">
                                                    <p className="flex items-center"><Ruler className="w-4 h-4 mr-2 text-blue-500" /> Total Length: {fabric.totalLength.toFixed(2)} {fabric.unit}</p>
                                                    <p className="flex items-center"><Shirt className="w-4 h-4 mr-2 text-green-500" /> Req. per Outfit: {fabric.lengthRequiredPerOutfit.toFixed(2)} {fabric.unit}</p>
                                                </div>
                                                {/* NEW: Last Updated By/Time */}
                                                <p className="text-xs text-gray-400 mt-2">
                                                    Last updated by:
                                                    <span className="font-semibold text-gray-600 ml-1">{fabric.updatedByEmail || 'System'}</span>
                                                    {fabric.updatedAt && (
                                                        <span className="ml-2">({fabric.updatedAt.toDate ? new Date(fabric.updatedAt.toDate()).toLocaleTimeString() : 'N/A'})</span>
                                                    )}
                                                </p>
                                            </div>
                                        </div>

                                        {/* Stock & Calculation */}
                                        <div className="w-full md:w-2/5 flex flex-col space-y-3">
                                            <div className="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                                                <div>
                                                    <p className="text-sm font-medium text-gray-500">Remaining Stock</p>
                                                    <p className="text-2xl font-extrabold text-blue-600">
                                                        {fabric.currentLength.toFixed(2)} {fabric.unit}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-sm font-medium text-gray-500">Potential Outfits</p>
                                                    <p className="2xl font-extrabold text-green-600">
                                                        {fabric.potentialOutfits}
                                                    </p>
                                                </div>
                                            </div>

                                            {/* Stock Update Form / Delete Button */}
                                            {updateFabricId === fabric.id ? (
                                                <form onSubmit={handleUpdateStock} className="flex space-x-2">
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        min="0.01"
                                                        required
                                                        placeholder={`Amount used (${fabric.unit})`}
                                                        className="flex-1 p-2 border border-yellow-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500"
                                                        value={updateAmountUsed}
                                                        onChange={(e) => setUpdateAmountUsed(e.target.value)}
                                                    />
                                                    <button
                                                        type="submit"
                                                        className="bg-yellow-500 text-white px-4 py-2 rounded-md font-medium hover:bg-yellow-600 transition duration-150"
                                                    >
                                                        Use
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={() => { setUpdateFabricId(null); setUpdateAmountUsed(''); }}
                                                        className="bg-gray-300 text-gray-800 px-3 py-2 rounded-md font-medium hover:bg-gray-400 transition duration-150"
                                                    >
                                                        Cancel
                                                    </button>
                                                </form>
                                            ) : (
                                                <div className="flex space-x-2">
                                                    <button
                                                        onClick={() => setUpdateFabricId(fabric.id)}
                                                        className="flex-1 bg-yellow-400 text-gray-900 px-4 py-2 rounded-md font-medium hover:bg-yellow-500 transition duration-150 shadow-md"
                                                    >
                                                        Update Stock (Use Material)
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteFabric(fabric.id)}
                                                        className="p-3 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition duration-150"
                                                        title="Delete Fabric Entry"
                                                    >
                                                        <Trash2 className="w-5 h-5" />
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the App
        const container = document.getElementById('root');
        // Use React 18's createRoot API
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>

</html>