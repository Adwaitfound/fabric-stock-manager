<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric Stock Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }

        .card {
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .loading-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="root">
        <div class="loading-container">
            <div class="spinner mr-3"></div>
            <div class="text-xl font-medium text-blue-500">Loading Application...</div>
        </div>
    </div>

    <!-- React and Babel for JSX in browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Icons (simplified from lucide-react for single-file HTML)
        const Plus = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const Trash2 = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>;
        const Gauge = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 14v4"></path><path d="M8.5 13.5l1 1"></path><path d="M15.5 13.5l-1 1"></path><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"></path></svg>;
        const Ruler = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 12L12 16L8 12"></path><path d="M4 4h16v16H4z"></path></svg>;
        const Shirt = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.5 4.5l-2.5 7h-11l-2.5-7"></path><path d="M22 10l-2 10"></path><path d="M2 10l2 10"></path><path d="M12 2l4 2.5v2.5H8V4.5z"></path></svg>;
        const Camera = (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-3h4l2 3h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2z"></path><circle cx="12" cy="13" r="3"></circle></svg>;

        // --- LOCAL STORAGE KEY ---
        const LOCAL_STORAGE_KEY = "poshakh_fabric_measure_stock";

        // Helper to load data from localStorage
        const loadFabricsFromLocalStorage = () => {
            try {
                const json = localStorage.getItem(LOCAL_STORAGE_KEY);
                return json ? JSON.parse(json) : [];
            } catch (e) {
                console.error("Could not load from local storage:", e);
                return [];
            }
        };

        // Helper to save data to localStorage
        const saveFabricsToLocalStorage = (data) => {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error("Could not save to local storage:", e);
            }
        };

        // Helper function to generate a unique ID
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

        // Helper function to convert a File object to a Base64 string
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
        });

        const App = () => {
            const [userId, setUserId] = useState(null);
            const [fabrics, setFabrics] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // Form State
            const [newFabric, setNewFabric] = useState({
                name: '',
                totalLength: '',
                unit: 'meters',
                lengthRequiredPerOutfit: '',
            });
            const [newFabricImageFile, setNewFabricImageFile] = useState(null);

            // State for updating current stock
            const [updateFabricId, setUpdateFabricId] = useState(null);
            const [updateAmountUsed, setUpdateAmountUsed] = useState('');

            // ------------------------------------
            // 1. INITIAL LOAD (FROM LOCAL STORAGE)
            // ------------------------------------

            useEffect(() => {
                // Load data on startup
                const storedFabrics = loadFabricsFromLocalStorage();

                // Calculate potential outfits during load
                const processedFabrics = storedFabrics.map(f => {
                    const currentLength = parseFloat(f.currentLength) || 0;
                    const lengthRequiredPerOutfit = parseFloat(f.lengthRequiredPerOutfit) || 1;
                    const potentialOutfits = Math.floor(currentLength / lengthRequiredPerOutfit);
                    return { ...f, currentLength, lengthRequiredPerOutfit, potentialOutfits };
                });

                setFabrics(processedFabrics);

                // Static user ID for Local Storage mode
                setUserId('LOCAL-STORAGE-MODE');
                setLoading(false);
            }, []);

            // ------------------------------------
            // 2. PERSISTENCE (SAVE TO LOCAL STORAGE)
            // ------------------------------------

            // Whenever the fabrics state changes, save it to local storage.
            useEffect(() => {
                if (!loading) {
                    // Only save the necessary fields
                    const dataToSave = fabrics.map(({ id, name, totalLength, currentLength, unit, lengthRequiredPerOutfit, imageUrl }) => ({
                        id, name, totalLength, currentLength, unit, lengthRequiredPerOutfit, imageUrl
                    }));
                    saveFabricsToLocalStorage(dataToSave);
                }
            }, [fabrics, loading]);


            // ------------------------------------
            // 3. CRUD FUNCTIONS (LOCAL STORAGE)
            // ------------------------------------

            const handleAddFabric = async (e) => {
                e.preventDefault();

                const { name, totalLength, unit, lengthRequiredPerOutfit } = newFabric;
                let imageUrlToStore = '';

                if (!name || !totalLength || !lengthRequiredPerOutfit) {
                    setError("Please fill in the fabric Name, Total Length, and Required Length per Outfit.");
                    return;
                }

                if (newFabricImageFile) {
                    if (newFabricImageFile.size > 500000) {
                        setError("Image file is too large. Please use a smaller image file (<500KB).");
                        return;
                    }
                    try {
                        imageUrlToStore = await fileToBase64(newFabricImageFile);
                    } catch (error) {
                        console.error("Error converting file to Base64:", error);
                        setError("Failed to process image file. Please try again or skip the image.");
                        return;
                    }
                } else {
                    imageUrlToStore = `https://placehold.co/100x100/38bdf8/ffffff?text=${name.substring(0, 2).toUpperCase()}`;
                }

                const docId = generateId();
                const currentLengthFloat = parseFloat(totalLength);
                const lengthRequiredPerOutfitFloat = parseFloat(lengthRequiredPerOutfit);

                const newDoc = {
                    id: docId,
                    name,
                    totalLength: currentLengthFloat,
                    currentLength: currentLengthFloat,
                    unit,
                    lengthRequiredPerOutfit: lengthRequiredPerOutfitFloat,
                    imageUrl: imageUrlToStore,
                    // Calculate derived fields immediately
                    potentialOutfits: Math.floor(currentLengthFloat / lengthRequiredPerOutfitFloat),
                    createdAt: new Date().toISOString(),
                };

                try {
                    setFabrics(prevFabrics => [...prevFabrics, newDoc]);
                    setNewFabric({ name: '', totalLength: '', unit: 'meters', lengthRequiredPerOutfit: '' });
                    setNewFabricImageFile(null);
                    setError(null);
                } catch (e) {
                    console.error("Error adding document: ", e);
                    setError("Failed to add new fabric stock to local storage.");
                }
            };

            const handleDeleteFabric = async (id) => {
                try {
                    setFabrics(prevFabrics => prevFabrics.filter(f => f.id !== id));
                    setError(null);
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    setError("Failed to delete fabric entry.");
                }
            };

            const handleUpdateStock = async (e) => {
                e.preventDefault();
                if (!updateFabricId || !updateAmountUsed) return;

                const amountUsed = parseFloat(updateAmountUsed);
                if (isNaN(amountUsed) || amountUsed <= 0) {
                    setError("Please enter a valid amount of fabric used (a positive number).");
                    return;
                }

                const fabricIndex = fabrics.findIndex(f => f.id === updateFabricId);
                if (fabricIndex === -1) return;

                const fabric = fabrics[fabricIndex];
                const newCurrentLength = fabric.currentLength - amountUsed;

                if (newCurrentLength < 0) {
                    setError(`Cannot use ${amountUsed} ${fabric.unit}. Only ${fabric.currentLength.toFixed(2)} ${fabric.unit} remaining.`);
                    return;
                }

                const newFabrics = [...fabrics];
                const lengthRequired = fabric.lengthRequiredPerOutfit;

                newFabrics[fabricIndex] = {
                    ...fabric,
                    currentLength: newCurrentLength,
                    potentialOutfits: Math.floor(newCurrentLength / lengthRequired) // Recalculate
                };

                try {
                    setFabrics(newFabrics);
                    setUpdateFabricId(null);
                    setUpdateAmountUsed('');
                    setError(null);
                } catch (e) {
                    console.error("Error updating stock: ", e);
                    setError("Failed to update fabric stock in local storage.");
                }
            };

            // ------------------------------------
            // 4. DERIVED STATE & UI RENDERING
            // ------------------------------------

            const totalPotentialOutfits = useMemo(() => {
                return fabrics.reduce((sum, f) => sum + f.potentialOutfits, 0);
            }, [fabrics]);

            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-50">
                        <div className="spinner mr-3"></div>
                        <div className="text-xl font-medium text-blue-500">Loading Application...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="p-8 bg-red-100 border-l-4 border-red-500 text-red-700 min-h-screen">
                        <p className="font-bold">Application Error</p>
                        <p>{error}</p>
                        <p className="mt-2 text-sm text-gray-600">Storage Mode: Local Storage (No Sharing)</p>
                    </div>
                );
            }

            return (
                <div className="p-4 md:p-8 bg-gray-50 min-h-screen font-sans">
                    <div className="max-w-6xl mx-auto">
                        <h1 className="text-4xl font-extrabold text-gray-900 mb-2">Fabric Stock Manager</h1>
                        <p className="text-sm text-gray-500 mb-6">
                            Storage ID: <span className="font-mono bg-gray-200 p-1 rounded-md text-xs">{userId}</span>
                        </p>
                        <p className="text-sm text-red-700 mb-6 bg-red-100 p-2 rounded-lg border border-red-300 font-semibold">
                            This version uses **Local Storage**. Data is saved ONLY on this device and is **NOT SHARED** with your team. To share data, you must use a database like Firebase.
                        </p>

                        {/* Global Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div className="card bg-blue-500 text-white p-6 rounded-xl shadow-lg flex items-center">
                                <Gauge className="w-8 h-8 mr-4" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Fabrics</p>
                                    <p className="text-3xl font-bold">{fabrics.length}</p>
                                </div>
                            </div>
                            <div className="card bg-green-500 text-white p-6 rounded-xl shadow-lg flex items-center col-span-1 md:col-span-2">
                                <Shirt className="w-8 h-8 mr-4" />
                                <div>
                                    <p className="text-sm opacity-80 uppercase font-semibold">Total Potential Outfits Remaining</p>
                                    <p className="text-3xl font-bold">{totalPotentialOutfits}</p>
                                </div>
                            </div>
                        </div>

                        {/* Add New Fabric Section */}
                        <div className="card bg-white p-6 rounded-xl shadow-lg mb-8">
                            <h2 className="text-2xl font-semibold text-gray-800 mb-4 flex items-center"><Plus className="w-5 h-5 mr-2" /> Add New Fabric Stock</h2>
                            <form onSubmit={handleAddFabric} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {/* Fabric Name */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Fabric Name</label>
                                    <input
                                        type="text"
                                        required
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500"
                                        value={newFabric.name}
                                        onChange={(e) => setNewFabric({ ...newFabric, name: e.target.value })}
                                    />
                                </div>

                                {/* Total Length */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Total Length in Stock</label>
                                    <div className="mt-1 flex rounded-md shadow-sm">
                                        <input
                                            type="number"
                                            step="0.01"
                                            min="0"
                                            required
                                            className="flex-1 block w-full rounded-l-md border-gray-300 p-2 border focus:ring-blue-500 focus:border-blue-500"
                                            value={newFabric.totalLength}
                                            onChange={(e) => setNewFabric({ ...newFabric, totalLength: e.target.value })}
                                        />
                                        <select
                                            className="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm"
                                            value={newFabric.unit}
                                            onChange={(e) => setNewFabric({ ...newFabric, unit: e.target.value })}
                                        >
                                            <option value="meters">meters</option>
                                            <option value="yards">yards</option>
                                        </select>
                                    </div>
                                </div>

                                {/* Length Required Per Outfit */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Length Required per Outfit</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        min="0.1"
                                        required
                                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500"
                                        value={newFabric.lengthRequiredPerOutfit}
                                        onChange={(e) => setNewFabric({ ...newFabric, lengthRequiredPerOutfit: e.target.value })}
                                    />
                                    <p className="mt-1 text-xs text-gray-500">How much {newFabric.unit} to make one average outfit?</p>
                                </div>

                                {/* Image Capture Input */}
                                <div className="md:col-span-2 lg:col-span-3">
                                    <label className="block text-sm font-medium text-gray-700">Fabric Image (Take Photo or Upload)</label>
                                    <div className="mt-1 flex items-center">
                                        <Camera className="w-5 h-5 text-gray-400 mr-2" />
                                        <input
                                            type="file"
                                            accept="image/*"
                                            capture="environment" // Mobile camera access
                                            className="flex-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                            onChange={(e) => setNewFabricImageFile(e.target.files[0] || null)}
                                        />
                                    </div>
                                    {newFabricImageFile && <p className="mt-1 text-xs text-green-600">File selected: {newFabricImageFile.name}</p>}
                                    <p className="mt-1 text-xs text-gray-500">Images are stored in local storage as a Base64 string.</p>
                                </div>

                                {/* Submit Button */}
                                <div className="md:col-span-2 lg:col-span-3 pt-2">
                                    <button
                                        type="submit"
                                        className="w-full justify-center inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150"
                                    >
                                        <Plus className="w-5 h-5 mr-2" /> Add Fabric to Stock
                                    </button>
                                </div>
                            </form>
                        </div>

                        {/* Current Stock List */}
                        <h2 className="text-3xl font-bold text-gray-900 mb-6">Current Fabric Stock ({fabrics.length} items)</h2>

                        {fabrics.length === 0 ? (
                            <div className="p-8 text-center bg-white rounded-xl shadow-lg text-gray-500">No fabric stock recorded yet. Use the form above to add an item!</div>
                        ) : (
                            <div className="grid grid-cols-1 gap-6">
                                {fabrics.map((fabric) => (
                                    <div key={fabric.id} className="card bg-white p-5 rounded-xl shadow-md flex flex-col md:flex-row justify-between items-start md:items-center">
                                        <div className="flex items-center mb-4 md:mb-0 w-full md:w-3/5">
                                            {/* Image Placeholder/Display */}
                                            <img
                                                src={fabric.imageUrl}
                                                alt={fabric.name}
                                                className="w-20 h-20 object-cover rounded-lg shadow-inner mr-4 border border-gray-200"
                                                onError={(e) => {
                                                    e.target.onerror = null;
                                                    e.target.src = `https://placehold.co/80x80/ef4444/ffffff?text=Image+N/A`;
                                                }}
                                            />
                                            {/* Fabric Details */}
                                            <div>
                                                <h3 className="text-xl font-bold text-gray-900">{fabric.name}</h3>
                                                <div className="text-sm text-gray-600 space-y-1 mt-1">
                                                    <p className="flex items-center"><Ruler className="w-4 h-4 mr-2 text-blue-500" /> Total Length: {fabric.totalLength.toFixed(2)} {fabric.unit}</p>
                                                    <p className="flex items-center"><Shirt className="w-4 h-4 mr-2 text-green-500" /> Req. per Outfit: {fabric.lengthRequiredPerOutfit.toFixed(2)} {fabric.unit}</p>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Stock & Calculation */}
                                        <div className="w-full md:w-2/5 flex flex-col space-y-3">
                                            <div className="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                                                <div>
                                                    <p className="text-sm font-medium text-gray-500">Remaining Stock</p>
                                                    <p className="text-2xl font-extrabold text-blue-600">
                                                        {fabric.currentLength.toFixed(2)} {fabric.unit}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-sm font-medium text-gray-500">Potential Outfits</p>
                                                    <p className="text-2xl font-extrabold text-green-600">
                                                        {fabric.potentialOutfits}
                                                    </p>
                                                </div>
                                            </div>

                                            {/* Stock Update Form / Delete Button */}
                                            {updateFabricId === fabric.id ? (
                                                <form onSubmit={handleUpdateStock} className="flex space-x-2">
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        min="0.01"
                                                        required
                                                        placeholder={`Amount used (${fabric.unit})`}
                                                        className="flex-1 p-2 border border-yellow-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500"
                                                        value={updateAmountUsed}
                                                        onChange={(e) => setUpdateAmountUsed(e.target.value)}
                                                    />
                                                    <button
                                                        type="submit"
                                                        className="bg-yellow-500 text-white px-4 py-2 rounded-md font-medium hover:bg-yellow-600 transition duration-150"
                                                    >
                                                        Use
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={() => { setUpdateFabricId(null); setUpdateAmountUsed(''); }}
                                                        className="bg-gray-300 text-gray-800 px-3 py-2 rounded-md font-medium hover:bg-gray-400 transition duration-150"
                                                    >
                                                        Cancel
                                                    </button>
                                                </form>
                                            ) : (
                                                <div className="flex space-x-2">
                                                    <button
                                                        onClick={() => setUpdateFabricId(fabric.id)}
                                                        className="flex-1 bg-yellow-400 text-gray-900 px-4 py-2 rounded-md font-medium hover:bg-yellow-500 transition duration-150 shadow-md"
                                                    >
                                                        Update Stock (Use Material)
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteFabric(fabric.id)}
                                                        className="p-3 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition duration-150"
                                                        title="Delete Fabric Entry"
                                                    >
                                                        <Trash2 className="w-5 h-5" />
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the App
        const container = document.getElementById('root');
        // Use React 18's createRoot API
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>

</html>